# 오프라인 가이드 모드 구현 계획

**작성일**: 2026-02-02  
**목표**: 여행 가이드 생성 후 인터넷 없이도 완전히 활용 가능한 오프라인 모드 구현

---

## 🎯 목표

여행 중 데이터 로밍 걱정 없이, 인터넷이 불안정한 환경에서도 생성한 가이드를 100% 활용할 수 있도록 만들기.

---

## 📋 Phase 1: 현재 상태 분석

### ✅ 이미 오프라인 작동하는 것들
- 여행 데이터 (localStorage)
- 체크리스트, 리뷰, 로그
- 업로드한 서류/사진 (Base64)
- 일정 순서 변경
- PWA 기본 캐싱

### ❌ 오프라인에서 안 되는 것들
1. **Google Maps** - 지도 타일 로딩 실패
2. **AI 기능** - Gemini API 호출 불가
3. **환율 API** - 실시간 환율 조회 불가
4. **외부 링크** - 구글 검색, 공식 웹사이트 등

---

## 🔧 Phase 2: 오프라인 최적화 전략

### 1. 지도 오프라인 대응 ⭐ 최우선

#### 옵션 A: 정적 지도 이미지로 대체 (추천)
```
- Google Maps Static API로 경로 이미지 생성
- IndexedDB에 저장
- 오프라인 시 이미지 표시
- 장점: 간단, 가벼움 (일차당 ~500KB)
- 단점: 확대/축소 불가
```

#### 옵션 B: Leaflet + 오프라인 타일
```
- Google Maps → Leaflet 복귀
- Leaflet.offline 플러그인으로 타일 캐싱
- 장점: 인터랙티브 유지
- 단점: 용량 큼 (10-50MB), 구현 복잡
```

#### 옵션 C: 하이브리드 (최적)
```
- 온라인: Google Maps (인터랙티브)
- 오프라인: 정적 경로 이미지 + 목록
- 네트워크 상태 자동 감지 및 전환
```

### 2. "오프라인 준비" 기능

#### 가이드 완성 후 실행
```
[📱 오프라인용 준비하기] 버튼 추가
↓
1. 모든 일차별 지도 이미지 생성
2. 필요한 리소스 캐싱 확인
3. "오프라인 준비 완료" 상태로 마킹
4. 완료 토스트: "이제 인터넷 없이도 사용 가능합니다!"
```

#### 자동 vs 수동
- **수동 (추천)**: 사용자가 버튼 클릭 시 준비
- **자동**: 가이드 생성 완료 시 자동 실행

### 3. 오프라인 모드 UI

#### 상단 상태 표시
```
[🌐 온라인] / [📵 오프라인 모드]
```

#### 오프라인 시 비활성화
- AI 재생성 버튼 (회색 처리)
- 외부 링크 (비활성화)
- 실시간 환율 (마지막 캐시값 표시)

#### 오프라인에서도 작동
- ✅ 전체 일정 보기
- ✅ 지도 (정적 이미지)
- ✅ 체크리스트
- ✅ 리뷰/로그 작성
- ✅ 서류 보기
- ✅ 회화 기능

### 4. Service Worker 강화

```javascript
// vite.config.ts - Workbox 설정 확장
workbox: {
  runtimeCaching: [
    // 폰트
    { urlPattern: /^https:\/\/fonts\.googleapis\.com/ },
    // Google Maps Static API 이미지
    { urlPattern: /^https:\/\/maps\.googleapis\.com\/maps\/api\/staticmap/ },
  ],
  navigateFallback: '/index.html'
}
```

### 5. 데이터 백업/복원 기능

```
설정 메뉴에 추가:
[내 여행 데이터 내보내기] → JSON 파일 다운로드
[여행 데이터 가져오기] → JSON 파일 업로드

용도:
- 기기 변경 시 데이터 이동
- 백업 보관
- 가족/친구와 공유
```

---

## 📱 Phase 3: 구현 우선순위

### 🔴 High Priority (필수)
1. **네트워크 상태 감지** - `navigator.onLine` 활용
2. **정적 지도 이미지 생성** - Google Maps Static API
3. **오프라인 모드 UI** - 상태 표시 + 기능 제한 안내
4. **"오프라인 준비" 버튼** - 가이드 완성 후 실행

### 🟡 Medium Priority (권장)
5. **환율 캐싱** - 마지막 조회값 저장
6. **Service Worker 확장** - 더 많은 리소스 캐싱
7. **데이터 내보내기/가져오기** - JSON 백업

### 🟢 Low Priority (선택)
8. **Leaflet 오프라인 타일** - 용량 부담 있음
9. **오프라인 검색** - 장소명 로컬 검색

---

## 💾 예상 저장 용량

```
기본 앱 캐시: ~5MB (HTML, CSS, JS, 폰트)
여행 데이터: ~1MB (JSON)
지도 이미지 (5일): ~2-3MB (일차별 경로 이미지)
업로드 서류: 사용자에 따라 (현재 Base64)
─────────────────────────
총 예상: 8-10MB (매우 가벼움!)
```

---

## 🎨 UI/UX 개선안

### 1. 가이드 완성 화면 (Step 9)
```
┌─────────────────────────────────┐
│  🎉 여행 가이드 생성 완료!       │
├─────────────────────────────────┤
│                                 │
│  [📱 오프라인용 준비하기]        │
│  여행 중 인터넷 없이도 사용      │
│                                 │
│  [✅ 가이드 보기]                │
│  [🔄 경로 재설정]                │
│                                 │
└─────────────────────────────────┘
```

### 2. 오프라인 모드 표시
```
상단 헤더:
[📵 오프라인 모드] 
마지막 동기화: 2시간 전
```

### 3. 지도 오프라인 폴백
```
┌─────────────────────────────────┐
│  Day 1 경로                     │
├─────────────────────────────────┤
│  [정적 지도 이미지]              │
│                                 │
│  ℹ️ 오프라인 모드입니다          │
│  인터랙티브 지도는 온라인에서    │
│  사용 가능합니다                │
└─────────────────────────────────┘
```

---

## 🚀 구현 단계별 작업

### Step 1: 네트워크 감지 (30분)
- `useOnlineStatus` 훅 생성
- 상태 표시 UI 추가

### Step 2: 정적 지도 생성 (1-2시간)
- Google Maps Static API 연동
- 일차별 경로 이미지 생성 함수
- IndexedDB 저장 로직

### Step 3: 오프라인 준비 버튼 (1시간)
- Step 9에 버튼 추가
- 지도 이미지 일괄 생성
- 진행 상태 표시

### Step 4: 오프라인 모드 UI (1시간)
- 조건부 렌더링 (온라인/오프라인)
- 기능 비활성화 처리
- 안내 메시지

### Step 5: 데이터 백업 (1시간)
- JSON 내보내기/가져오기
- 설정 메뉴 추가

**총 예상 시간: 4-6시간**

---

## ⚠️ 주의사항

### 1. Google Maps Static API 비용
- 무료: 월 28,500회 요청
- 1회 여행당 ~5-10회 사용 예상
- 충분히 무료 범위 내

### 2. 저장 용량 제한
- localStorage: 5-10MB
- IndexedDB: 50MB+ (브라우저마다 다름)
- 지도 이미지는 IndexedDB 권장

### 3. iOS Safari 제약
- PWA 설치 시 저장소 제한 완화
- 주기적으로 앱 실행 필요 (캐시 유지)

---

## 🤔 검토 포인트

### 1. 지도 오프라인 방식
- [ ] 옵션 A: 정적 이미지만
- [ ] 옵션 B: Leaflet 타일
- [ ] 옵션 C: 하이브리드 (추천)

### 2. 구현 범위
- [ ] High Priority만 (필수 기능)
- [ ] High + Medium (권장)
- [ ] 전체 구현

### 3. 오프라인 준비 방식
- [ ] 수동 (버튼 클릭)
- [ ] 자동 (가이드 생성 시)

### 4. 데이터 백업
- [ ] JSON 파일 내보내기/가져오기
- [ ] 클라우드 동기화 (나중에)

---

## 📝 다음 단계

검토 후 결정 사항:
1. 지도 방식 선택
2. 구현 우선순위 확정
3. 작업 시작 승인

**검토 후 의견 주시면 바로 작업 시작하겠습니다!**
